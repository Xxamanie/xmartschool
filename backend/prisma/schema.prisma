datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
}

enum SchoolStatus {
  Active
  Inactive
}

enum StudentStatus {
  Active
  Inactive
  Suspended
}

enum ExamStatus {
  scheduled
  active
  ended
}

enum AttendanceStatus {
  Present
  Absent
  Late
  Excused
}

enum LiveClassStatus {
  scheduled
  active
  ended
  cancelled
}

enum ExamSessionStatus {
  in_progress
  submitted
  timed_out
  cancelled
}

enum ResultStatus {
  passed
  failed
  incomplete
  withheld
}

enum SchemeStatus {
  Pending
  Approved
  Rejected
}

enum TargetAudience {
  all
  teachers
  students
}

enum QuestionType {
  multiple_choice
  true_false
  short_answer
  essay
}

enum AIActivityScope {
  assessments
  results
  proctoring
  live_classes
  general
}

enum AIActivityStatus {
  success
  failed
  fallback
}

model School {
  id                    String                 @id @default(cuid())
  name                  String
  code                  String?                @unique
  region                String?
  adminName             String?
  status                SchoolStatus           @default(Active)
  studentCount          Int                    @default(0)
  motto                 String                 @default("")
  logoUrl               String                 @default("")
  address               String                 @default("")
  contact               String                 @default("")
  users                 User[]
  students              Student[]
  subjects              Subject[]
  assessments           Assessment[]
  results               Result[]
  schemes               SchemeSubmission[]
  announcements         Announcement[]
  liveClasses           LiveClass[]
  liveClassParticipants LiveClassParticipant[]
  liveClassMessages     LiveClassMessage[]
  liveClassRecordings   LiveClassRecording[]
  exams                 Exam[]
  examQuestions         ExamQuestion[]
  examSessions          ExamSession[]
  attendanceRecords     AttendanceRecord[]
  classMasters          ClassMaster[]
  proctoringAlerts      ProctoringAlert[]
  aiActivities          AIActivity[]
}

model User {
  id           String        @id @default(cuid())
  name         String
  email        String?       @unique
  password     String
  role         UserRole
  avatar       String?
  schoolId     String
  school       School        @relation(fields: [schoolId], references: [id])
  gender       String?
  phone        String?
  bio          String?
  subjects     Subject[]     @relation("SubjectTeacher")
  exams        Exam[]        @relation("ExamTeacher")
  classMasters ClassMaster[]
  liveClasses  LiveClass[]   @relation("LiveClassTeacher")
  aiActivities AIActivity[]

  @@index([schoolId])
}

model Student {
  id               String             @id @default(uuid())
  name             String
  gender           String
  grade            String
  enrollmentDate   DateTime
  status           StudentStatus      @default(Active)
  gpa              Float              @default(0)
  attendance       Int                @default(0)
  accessCode       String             @unique
  resultAccessCode String?            @unique
  isPaid           Boolean            @default(false)
  enrolledSubjects String[]           @default([])
  schoolId         String
  school           School             @relation(fields: [schoolId], references: [id])
  assessments      Assessment[]
  results          Result[]
  examSessions     ExamSession[]
  attendanceLogs   AttendanceRecord[]
  proctoringAlerts ProctoringAlert[]

  @@index([schoolId])
}

model Subject {
  id          String             @id @default(cuid())
  name        String
  teacherId   String?
  teacher     User?              @relation("SubjectTeacher", fields: [teacherId], references: [id])
  schedule    String?
  room        String?
  schoolId    String
  school      School             @relation(fields: [schoolId], references: [id])
  assessments Assessment[]
  results     Result[]
  exams       Exam[]
  schemes     SchemeSubmission[]
  liveClasses LiveClass[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Assessment {
  id        String  @id @default(cuid())
  schoolId  String
  school    School  @relation(fields: [schoolId], references: [id])
  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])
  term      String
  ca1       Float   @default(0)
  ca2       Float   @default(0)
  ca3       Float   @default(0)
  exam      Float   @default(0)

  @@unique([schoolId, studentId, subjectId, term])
  @@index([schoolId, studentId])
  @@index([schoolId, subjectId])
}

model Result {
  id          String       @id @default(cuid())
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id])
  studentId   String
  student     Student      @relation(fields: [studentId], references: [id])
  subjectId   String?
  subject     Subject?     @relation(fields: [subjectId], references: [id])
  subjectName String
  average     Float
  grade       String
  status      ResultStatus
  remarks     String?
  details     Json?

  @@unique([schoolId, studentId, subjectName])
  @@index([schoolId, studentId])
}

model SchemeSubmission {
  id          String       @id @default(cuid())
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id])
  subjectId   String?
  subject     Subject?     @relation(fields: [subjectId], references: [id])
  subjectName String
  term        String
  uploadDate  DateTime     @default(now())
  status      SchemeStatus @default(Pending)
  fileName    String

  @@index([schoolId, subjectId])
}

model Announcement {
  id             String         @id @default(cuid())
  schoolId       String
  school         School         @relation(fields: [schoolId], references: [id])
  title          String
  message        String
  targetAudience TargetAudience
  source         String
  createdAt      DateTime       @default(now())

  @@index([schoolId, createdAt])
}

model LiveClass {
  id            String              @id @default(cuid())
  schoolId      String
  school        School              @relation(fields: [schoolId], references: [id])
  subjectId     String?
  teacherId     String?
  scheduledTime DateTime
  meetingLink   String
  status        LiveClassStatus     @default(scheduled)
  recording     LiveClassRecording?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  subject      Subject?               @relation(fields: [subjectId], references: [id])
  teacher      User?                  @relation("LiveClassTeacher", fields: [teacherId], references: [id])
  participants LiveClassParticipant[]
  messages     LiveClassMessage[]

  @@index([schoolId, scheduledTime])
}

model LiveClassParticipant {
  id           String    @id @default(cuid())
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  liveClassId  String
  liveClass    LiveClass @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  userId       String
  joinedAt     DateTime  @default(now())
  leftAt       DateTime?
  cameraOn     Boolean   @default(false)
  microphoneOn Boolean   @default(false)
  handRaised   Boolean   @default(false)

  @@unique([liveClassId, userId])
  @@index([schoolId, liveClassId])
}

model LiveClassMessage {
  id          String    @id @default(cuid())
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id])
  liveClassId String
  liveClass   LiveClass @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  userId      String
  message     String
  createdAt   DateTime  @default(now())

  @@index([schoolId, liveClassId])
}

model LiveClassRecording {
  id           String    @id @default(cuid())
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  liveClassId  String    @unique
  liveClass    LiveClass @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  recordingUrl String
  duration     Int       @default(0)
  createdAt    DateTime  @default(now())

  @@index([schoolId, liveClassId])
}

model Exam {
  id               String            @id @default(cuid())
  schoolId         String
  school           School            @relation(fields: [schoolId], references: [id])
  title            String
  status           ExamStatus        @default(scheduled)
  duration         Int               @default(60)
  teacherId        String?
  teacher          User?             @relation("ExamTeacher", fields: [teacherId], references: [id])
  subjectId        String?
  subject          Subject?          @relation(fields: [subjectId], references: [id])
  term             String            @default("Term 1")
  questions        ExamQuestion[]
  sessions         ExamSession[]
  proctoringAlerts ProctoringAlert[]

  @@index([schoolId, subjectId])
}

model ExamQuestion {
  id            String       @id @default(cuid())
  schoolId      String
  school        School       @relation(fields: [schoolId], references: [id])
  examId        String
  exam          Exam         @relation(fields: [examId], references: [id])
  type          QuestionType
  text          String
  options       Json?
  correctAnswer String?
  points        Int          @default(1)
  isAutoGrade   Boolean      @default(false)
  rubric        String?

  @@index([schoolId, examId])
}

model ExamSession {
  id        String            @id @default(cuid())
  schoolId  String
  school    School            @relation(fields: [schoolId], references: [id])
  examId    String
  exam      Exam              @relation(fields: [examId], references: [id])
  studentId String
  student   Student           @relation(fields: [studentId], references: [id])
  status    ExamSessionStatus @default(in_progress)
  progress  Int               @default(0)
  score     Float?
  startTime DateTime?         @default(now())
  endTime   DateTime?
  answers   Json?

  @@unique([schoolId, examId, studentId])
  @@index([schoolId, studentId])
}

model AttendanceRecord {
  id        String           @id @default(cuid())
  schoolId  String
  school    School           @relation(fields: [schoolId], references: [id])
  studentId String
  student   Student          @relation(fields: [studentId], references: [id])
  status    AttendanceStatus
  date      DateTime

  @@unique([schoolId, studentId, date])
  @@index([schoolId, studentId])
}

model ClassMaster {
  id        String @id @default(cuid())
  schoolId  String
  school    School @relation(fields: [schoolId], references: [id])
  grade     String
  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])

  @@unique([schoolId, grade])
  @@index([schoolId])
}

model ProctoringAlert {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id])
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  description String
  timestamp   DateTime @default(now())

  @@index([schoolId, examId])
}

model AIActivity {
  id        String           @id @default(cuid())
  action    String
  scope     AIActivityScope  @default(general)
  status    AIActivityStatus @default(success)
  actorId   String?
  actorRole UserRole?
  schoolId  String
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User?            @relation(fields: [actorId], references: [id])
  school    School           @relation(fields: [schoolId], references: [id])

  @@index([createdAt])
  @@index([scope, status])
  @@index([actorId, createdAt])
  @@index([schoolId, createdAt])
}
