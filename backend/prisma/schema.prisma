datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
}

enum SchoolStatus {
  Active
  Inactive
}

enum StudentStatus {
  Active
  Inactive
  Suspended
}

enum ExamStatus {
  scheduled
  active
  ended
}

enum AttendanceStatus {
  Present
  Absent
  Late
  Excused
}

enum SchemeStatus {
  Pending
  Approved
  Rejected
}

enum TargetAudience {
  all
  teachers
  students
}

enum QuestionType {
  multiple_choice
  true_false
  short_answer
  essay
}

enum AIActivityScope {
  assessments
  results
  proctoring
  live_classes
  general
}

enum AIActivityStatus {
  success
  failed
  fallback
}

model School {
  id           String        @id @default(cuid())
  name         String
  code         String?       @unique
  region       String?
  adminName    String?
  status       SchoolStatus  @default(Active)
  studentCount Int           @default(0)
  motto        String        @default("")
  logoUrl      String        @default("")
  address      String        @default("")
  contact      String        @default("")
  users        User[]
  students     Student[]
  subjects     Subject[]
  aiActivities AIActivity[]
}

model User {
id          String   @id @default(cuid())
name        String
email       String?  @unique
password    String
role        UserRole
avatar      String?
schoolId    String?
school      School?  @relation(fields: [schoolId], references: [id])
gender      String?
phone       String?
bio         String?
subjects    Subject[] @relation("SubjectTeacher")
exams       Exam[]    @relation("ExamTeacher")
classMasters ClassMaster[]
liveClasses LiveClass[] @relation("LiveClassTeacher")
aiActivities AIActivity[]
}

model Student {
  id                String           @id @default(uuid())
  name              String
  gender            String
  grade             String
  enrollmentDate    DateTime
  status            StudentStatus    @default(Active)
  gpa               Float            @default(0)
  attendance        Int              @default(0)
  accessCode        String           @unique
  resultAccessCode  String?          @unique
  isPaid            Boolean          @default(false)
  enrolledSubjects  String[]         @default([])
  schoolId          String
  school            School           @relation(fields: [schoolId], references: [id])
  assessments       Assessment[]
  results           Result[]
  examSessions      ExamSession[]
  attendanceLogs    AttendanceRecord[]
}

model Subject {
  id          String            @id @default(cuid())
  name        String
  teacherId   String?
  teacher     User?             @relation("SubjectTeacher", fields: [teacherId], references: [id])
  schedule    String?
  room        String?
  schoolId    String?
  school      School?           @relation(fields: [schoolId], references: [id])
  assessments Assessment[]
  results     Result[]
  exams       Exam[]
  schemes     SchemeSubmission[]
  liveClasses LiveClass[]
}

model Assessment {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  term      String
  ca1       Float    @default(0)
  ca2       Float    @default(0)
  ca3       Float    @default(0)
  exam      Float    @default(0)
}

model Result {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  subjectId   String?
  subject     Subject? @relation(fields: [subjectId], references: [id])
  subjectName String
  average     Float
  grade       String
  status      String
  remarks     String?
  details     Json?

  @@unique([studentId, subjectName])
}

model SchemeSubmission {
  id          String       @id @default(cuid())
  subjectId   String?
  subject     Subject?     @relation(fields: [subjectId], references: [id])
  subjectName String
  term        String
  uploadDate  DateTime     @default(now())
  status      SchemeStatus @default(Pending)
  fileName    String
}

model Announcement {
  id             String          @id @default(cuid())
  title          String
  message        String
  targetAudience TargetAudience
  source         String
  createdAt      DateTime        @default(now())
}

model LiveClass {
  id            String                    @id @default(cuid())
  subjectId     String?
  teacherId     String?
  scheduledTime DateTime
  meetingLink   String
  status        String                    @default("scheduled")
  recording     LiveClassRecording?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  subject       Subject?                  @relation(fields: [subjectId], references: [id])
  teacher       User?                     @relation("LiveClassTeacher", fields: [teacherId], references: [id])
  participants  LiveClassParticipant[]
  messages      LiveClassMessage[]
}

model LiveClassParticipant {
  id            String       @id @default(cuid())
  liveClassId   String
  liveClass     LiveClass    @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  userId        String
  joinedAt      DateTime     @default(now())
  leftAt        DateTime?
  cameraOn      Boolean      @default(false)
  microphoneOn  Boolean      @default(false)
  handRaised    Boolean      @default(false)

  @@unique([liveClassId, userId])
}

model LiveClassMessage {
  id            String       @id @default(cuid())
  liveClassId   String
  liveClass     LiveClass    @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  userId        String
  message       String
  createdAt     DateTime     @default(now())
}

model LiveClassRecording {
  id            String       @id @default(cuid())
  liveClassId   String       @unique
  liveClass     LiveClass    @relation(fields: [liveClassId], references: [id], onDelete: Cascade)
  recordingUrl  String
  duration      Int          @default(0)
  createdAt     DateTime     @default(now())
}

model Exam {
  id        String     @id @default(cuid())
  title     String
  status    ExamStatus @default(scheduled)
  duration  Int        @default(60)
  teacherId String?
  teacher   User?      @relation("ExamTeacher", fields: [teacherId], references: [id])
  subjectId String?
  subject   Subject?   @relation(fields: [subjectId], references: [id])
  term      String     @default("Term 1")
  questions ExamQuestion[]
  sessions  ExamSession[]
}

model ExamQuestion {
  id            String       @id @default(cuid())
  examId        String
  exam          Exam         @relation(fields: [examId], references: [id])
  type          QuestionType
  text          String
  options       Json?
  correctAnswer String?
  points        Int          @default(1)
  isAutoGrade   Boolean      @default(false)
  rubric       String?
}

model ExamSession {
  id         String    @id @default(cuid())
  examId     String
  exam       Exam      @relation(fields: [examId], references: [id])
  studentId  String
  student    Student   @relation(fields: [studentId], references: [id])
  status     String    @default("in-progress")
  progress   Int       @default(0)
  score      Float?
  startTime  DateTime? @default(now())
  endTime    DateTime?
  answers    Json?

  @@unique([examId, studentId])
}

model AttendanceRecord {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id])
  status    AttendanceStatus
  date      DateTime

  @@unique([studentId, date])
}

model ClassMaster {
  id        String @id @default(cuid())
  grade     String @unique
  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])
}

model ProctoringAlert {
  id          String   @id @default(cuid())
  examId      String
  studentId   String
  description String
  timestamp   DateTime @default(now())
}

model AIActivity {
  id        String           @id @default(cuid())
  action    String
  scope     AIActivityScope  @default(general)
  status    AIActivityStatus @default(success)
  actorId   String?
  actorRole UserRole?
  schoolId  String?
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User?            @relation(fields: [actorId], references: [id])
  school    School?          @relation(fields: [schoolId], references: [id])

  @@index([createdAt])
  @@index([scope, status])
  @@index([actorId, createdAt])
  @@index([schoolId, createdAt])
}
