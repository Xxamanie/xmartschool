# Environment Variables Setup

This document explains how to configure environment variables for frontend and backend deployments.

## Security Best Practices

⚠️ **IMPORTANT**: Never commit `.env.production` or any file with actual secrets to version control.

- `.env.production` is in `.gitignore` for security
- Use `.env.production.example` as a reference for required variables
- Store production secrets in platform-specific secret managers:
  - **GitHub Actions**: Repository Secrets (Settings → Secrets and variables → Actions)
  - **Render**: Environment variables in service dashboard
  - **Firebase**: Environment files are non-sensitive (only VITE_* vars)

---

## Frontend (.env.production)

**Location**: `c:\Users\user\xmartschool\.env.production`

**Example** (`.env.production.example`):
```
VITE_API_BASE_URL=https://xmartschool.onrender.com/api
VITE_GEMINI_API_KEY=
```

### Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_API_BASE_URL` | ✓ | Render backend API base URL with `/api` suffix |
| `VITE_GEMINI_API_KEY` | ✗ | Google Gemini API key (optional, for AI features) |

### How to Set

**Local Development**:
```bash
# Create .env.production locally
cp .env.production.example .env.production
# Edit .env.production with your values
```

**GitHub Actions (Auto-deployed)**:
Set in GitHub repository → Settings → Secrets and variables → Actions:
- `VITE_API_BASE_URL`: `https://xmartschool.onrender.com/api`
- `VITE_GEMINI_API_KEY`: (if needed)

See `.github/workflows/firebase-hosting-merge.yml` for usage.

---

## Backend (.env.production)

**Location**: `c:\Users\user\xmartschool\backend\.env.production`

**Example** (`.env.production.example`):
```
DATABASE_URL=postgresql://user:password@dpg-xxxxx.onrender.com:5432/dbname
PORT=4000
NODE_ENV=production
CORS_ORIGIN=https://xmartschool.web.app,https://xmartschool.firebaseapp.com
GEMINI_API_KEY=
```

### Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `DATABASE_URL` | ✓ | PostgreSQL connection string (Render) |
| `PORT` | ✓ | Server port (usually 4000) |
| `NODE_ENV` | ✓ | Environment (production/development) |
| `CORS_ORIGIN` | ✗ | Comma-separated CORS origins |
| `GEMINI_API_KEY` | ✗ | Google Gemini API key (optional) |

### How to Set

**Render Dashboard**:
1. Go to [render.com](https://render.com) → Your backend service
2. Click **Environment** or **Settings** → **Environment**
3. Add/update each variable
4. Service automatically redeploys with new variables

**Local Development**:
```bash
# Create .env.production locally in backend/
cd backend
cp .env.production.example .env.production
# Edit .env.production with Render PostgreSQL connection details
```

**Validation**: Backend validates required vars at startup. If missing, deployment fails with error message.

---

## GitHub Actions Secrets

All production secrets are injected via GitHub Actions, not version control.

**To add/update secrets**:
1. Go to repository → Settings → Secrets and variables → Actions
2. Click **New repository secret**
3. Add the secret name and value

**Currently used secrets**:
- `VITE_API_BASE_URL`: Frontend API URL
- `VITE_GEMINI_API_KEY`: Frontend Gemini key
- `FIREBASE_SERVICE_ACCOUNT_XMART_SCHOOL`: Firebase deploy credentials
- `GITHUB_TOKEN`: Auto-generated by GitHub

---

## Deployment Flow

```
Local: Edit code
  ↓
Push to GitHub
  ↓
GitHub Actions workflow triggered
  ↓
Reads secrets from GitHub
  ↓
Frontend build:
  - Injects VITE_* variables (Vite exposes these)
  - Builds React app
  ↓
Deploy to Firebase Hosting
  (vars baked into frontend build)
  ↓
Backend (separate):
  - Render reads DATABASE_URL from dashboard
  - Validates on startup
  - Runs with PostgreSQL connection
```

---

## Troubleshooting

### Frontend: "VITE_API_BASE_URL=..." shown as literal string in console
**Cause**: Environment variable not loaded during build
**Fix**: 
- Check `.env.production` exists with correct value
- Run `npm run build` locally with env var set
- Check GitHub secret `VITE_API_BASE_URL` is configured

### Backend: "DATABASE_URL not found" error
**Cause**: Missing PostgreSQL connection string
**Fix**:
- Set `DATABASE_URL` in Render dashboard
- Verify connection string is valid (check Render → PostgreSQL → Connection)
- Restart Render service

### CORS errors
**Cause**: Frontend domain not in backend CORS whitelist
**Fix**:
- Add Firebase Hosting domain to `CORS_ORIGIN` in backend `.env`
- Restart Render service
- Firebase Hosting URL: `https://xmartschool.web.app`

---

## Reference Files

- Frontend example: `.env.production.example`
- Backend example: `backend/.env.production.example`
- GitHub Actions: `.github/workflows/firebase-hosting-merge.yml`
- Backend config validation: `backend/src/config/env.ts`
